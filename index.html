<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Platform 2025 | Admin Mode</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div id="app"></div>

    <script>
        const S_URL = "https://ihwxjkqzjaacizarwugc.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlod3hqa3F6amFhY2l6YXJ3dWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNTEzNzcsImV4cCI6MjA4MTcyNzM3N30.wP8r-0PoBtF8pgP1cv_nSW4ueHPnRSeLQtdv9nA8Vu0";
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let currentUser = null;
        
        // –í–ü–ò–®–ò –°–í–û–ô –õ–û–ì–ò–ù –í –ö–ê–í–´–ß–ö–ò –ù–ò–ñ–ï (–Ω–∞–ø—Ä–∏–º–µ—Ä, "@boss")
        const ADMIN_USERNAME = "@adminplatformi"; 

        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border">
                        <h2 class="text-2xl font-black mb-6 text-center text-blue-600">–í–•–û–î</h2>
                        <input type="text" id="uname" placeholder="–õ–æ–≥–∏–Ω" class="w-full p-3 mb-3 border rounded-xl outline-none">
                        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 mb-6 border rounded-xl outline-none">
                        <button onclick="handleLogin()" id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all">–í–û–ô–¢–ò</button>
                    </div>
                </div>`;
        }

        async function handleLogin() {
            const u = document.getElementById('uname').value;
            const p = document.getElementById('pass').value;
            const { data } = await _supabase.from('users').select('*').eq('username', u).eq('password', p).single();
            if (data) { currentUser = data; showDashboard(); } else { alert("–û—à–∏–±–∫–∞!"); }
        }

        function showDashboard() {
            document.getElementById('app').innerHTML = `
                <nav class="bg-white border-b p-4 flex justify-between items-center shadow-sm">
                    <span class="font-black text-blue-600 uppercase text-xl">Platform 2025</span>
                    <span class="text-sm font-bold bg-blue-50 text-blue-700 px-4 py-1 rounded-full border border-blue-100">üë§ ${currentUser.first_name}</span>
                </nav>
                <main class="p-6 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-black mb-8">–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div onclick="showChat('–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞')" class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-xl transition-all group">
                            <div class="text-4xl mb-4">üìê</div>
                            <h3 class="text-xl font-black">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h3>
                        </div>
                    </div>
                </main>`;
        }

        async function showChat(subject) {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col h-screen bg-white">
                    <header class="p-4 bg-white border-b flex items-center gap-4">
                        <button onclick="showDashboard()" class="bg-gray-100 p-2 rounded-full">‚Üê</button>
                        <h2 class="font-black text-lg uppercase">${subject}</h2>
                    </header>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50"></div>
                    <div class="p-4 bg-white border-t flex gap-3">
                        <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 p-3 bg-gray-100 rounded-2xl outline-none">
                        <button onclick="sendMessage()" class="bg-blue-600 text-white w-12 h-12 rounded-2xl">‚û§</button>
                    </div>
                </div>`;
            loadMessages();
            if (window.chatInterval) clearInterval(window.chatInterval);
            window.chatInterval = setInterval(loadMessages, 3000);
        }

        async function loadMessages() {
            const { data } = await _supabase.from('messages').select('*').order('created_at', { ascending: true });
            const box = document.getElementById('chat-box');
            if (box && data) {
                box.innerHTML = data.map(m => `
                    <div class="flex flex-col ${m.sender_name === currentUser.first_name ? 'items-end' : 'items-start'} group">
                        <span class="text-[10px] font-bold text-gray-400 mb-1 px-2 uppercase">${m.sender_name}</span>
                        <div class="relative max-w-[85%] p-3 px-4 rounded-2xl shadow-sm text-sm ${m.sender_name === currentUser.first_name ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none'}">
                            ${m.text}
                            ${currentUser.username === ADMIN_USERNAME ? `
                                <button onclick="deleteMessage(${m.id})" class="absolute -top-2 -left-2 bg-red-500 text-white text-[8px] w-4 h-4 rounded-full opacity-0 group-hover:opacity-100 transition-all">‚úï</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            }
        }

        async function deleteMessage(msgId) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
            const { error } = await _supabase.from('messages').delete().eq('id', msgId);
            if (!error) loadMessages();
            else alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + error.message);
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;
            await _supabase.from('messages').insert([{ text: text, sender_name: currentUser.first_name, role: currentUser.role }]);
            input.value = '';
            loadMessages();
        }

        showLogin();
    </script>
</body>
</html>
