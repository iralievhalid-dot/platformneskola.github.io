<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Platform 2025 | Education</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div id="app"></div>

    <script>
        const S_URL = "https://ihwxjkqzjaacizarwugc.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlod3hqa3F6amFhY2l6YXJ3dWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNTEzNzcsImV4cCI6MjA4MTcyNzM3N30.wP8r-0PoBtF8pgP1cv_nSW4ueHPnRSeLQtdv9nA8Vu0";
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let currentUser = null;

        // –≠–ö–†–ê–ù –í–•–û–î–ê
        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border">
                        <h2 class="text-2xl font-black mb-6 text-center text-blue-600">–í–•–û–î</h2>
                        <input type="text" id="uname" placeholder="–õ–æ–≥–∏–Ω" class="w-full p-3 mb-3 border rounded-xl outline-none">
                        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 mb-6 border rounded-xl outline-none">
                        <button onclick="handleLogin()" id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">–í–û–ô–¢–ò</button>
                    </div>
                </div>`;
        }

        async function handleLogin() {
            const u = document.getElementById('uname').value;
            const p = document.getElementById('pass').value;
            const { data, error } = await _supabase.from('users').select('*').eq('username', u).eq('password', p).single();
            
            if (data) {
                currentUser = data;
                showDashboard();
            } else {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞!");
            }
        }

        // –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
        function showDashboard() {
            document.getElementById('app').innerHTML = `
                <nav class="bg-white border-b p-4 flex justify-between items-center shadow-sm">
                    <span class="font-black text-blue-600">MY SCHOOL</span>
                    <span class="text-sm font-bold bg-gray-100 px-3 py-1 rounded-full">üë§ ${currentUser.first_name}</span>
                </nav>
                <main class="p-6 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-black mb-8">–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10">
                        <div onclick="showChat('–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞')" class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-500 cursor-pointer hover:scale-105 transition">
                            <h3 class="text-xl font-bold">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h3>
                            <p class="text-gray-500 text-sm">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ —á–∞—Ç —É—Ä–æ–∫–∞</p>
                        </div>
                        <div onclick="showChat('–†—É—Å—Å–∫–∏–π —è–∑—ã–∫')" class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500 cursor-pointer hover:scale-105 transition">
                            <h3 class="text-xl font-bold">üá∑üá∫ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫</h3>
                            <p class="text-gray-500 text-sm">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ —á–∞—Ç —É—Ä–æ–∫–∞</p>
                        </div>
                    </div>
                </main>`;
        }

        // –û–ö–ù–û –ß–ê–¢–ê
        async function showChat(subject) {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col h-screen">
                    <header class="p-4 bg-white border-b flex justify-between items-center">
                        <button onclick="showDashboard()" class="text-blue-600">‚Üê –ù–∞–∑–∞–¥</button>
                        <h2 class="font-bold">${subject}</h2>
                        <div></div>
                    </header>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                        </div>
                    <div class="p-4 bg-white border-t flex gap-2">
                        <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 p-2 border rounded-lg outline-none">
                        <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>`;
            loadMessages();
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            setInterval(loadMessages, 3000);
        }

        async function loadMessages() {
            const { data } = await _supabase.from('messages').select('*').order('created_at', { ascending: true });
            const box = document.getElementById('chat-box');
            if (box) {
                box.innerHTML = data.map(m => `
                    <div class="max-w-[80%] ${m.sender_name === currentUser.first_name ? 'ml-auto' : ''}">
                        <div class="text-[10px] text-gray-400 mb-1">${m.sender_name} (${m.role})</div>
                        <div class="${m.role === 'teacher' ? 'bg-blue-600 text-white' : 'bg-white border text-gray-800'} p-3 rounded-2xl shadow-sm text-sm">
                            ${m.text}
                        </div>
                    </div>
                `).join('');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if (!text) return;

            await _supabase.from('messages').insert([
                { text: text, sender_name: currentUser.first_name, role: currentUser.role }
            ]);
            input.value = '';
            loadMessages();
        }

        showLogin();
    </script>
</body>
</html>
